# Target Repository Structure

**Last Updated**: 2025-10-12 15:40:59
**Purpose**: Current vs. target repository structure with migration annotations
**Status**: Generated by Repository Structure Validation Agent

## Overview

This document maps the current backend repository structure against canonical specifications and provides annotations for required changes.

## Annotation Legend

- **[KEEP]**: File correctly located, follows canonical patterns
- **[DELETE]**: Obsolete file, should be removed (reason provided)
- **[UPDATE]**: File needs architecture compliance updates
- **[MOVE]**: File in wrong location, migration path provided
- **[CREATE]**: Missing file required by specs

## Backend Structure (`backend/src/basis_strategy_v1/`)

### Core Components (`core/`)

#### Strategies (`core/strategies/`)

```
core/strategies/
├── __init__.py                                    [KEEP] - Canonical pattern
├── base_strategy_manager.py                       [KEEP] - Per 5B_BASE_STRATEGY_MANAGER.md
├── strategy_factory.py                            [KEEP] - Per 5A_STRATEGY_FACTORY.md
├── pure_lending_strategy.py                       [KEEP] - Per MODES.md
├── btc_basis_strategy.py                          [KEEP] - Per MODES.md
├── eth_basis_strategy.py                          [KEEP] - Per MODES.md
├── eth_staking_only_strategy.py                   [KEEP] - Per MODES.md
├── eth_leveraged_strategy.py                      [KEEP] - Per MODES.md
├── usdt_market_neutral_no_leverage_strategy.py    [KEEP] - Per MODES.md
├── usdt_market_neutral_strategy.py                [KEEP] - Per MODES.md
└── components/                                    [UPDATE] - Contains files to relocate
    ├── __init__.py                                [KEEP]
    ├── position_monitor.py                        [MOVE → core/components/] - Should be top-level core component per 01_POSITION_MONITOR.md
    ├── exposure_monitor.py                        [MOVE → core/components/] - Should be top-level core component per 02_EXPOSURE_MONITOR.md
    ├── risk_monitor.py                            [MOVE → core/components/] - Should be top-level core component per 03_RISK_MONITOR.md
    ├── strategy_manager.py                        [DELETE] - Duplicate of base_strategy_manager.py
    ├── position_update_handler.py                 [MOVE → core/components/] - Per 11_POSITION_UPDATE_HANDLER.md
    ├── execution_manager.py                       [MOVE → core/execution/] - Already exists there, remove duplicate
    ├── data_provider.py                           [DELETE] - Use infrastructure/data/data_provider_factory.py
    ├── data_subscriptions.py                      [DELETE] - Obsolete, modes use data_requirements config
    └── event_logger.py                            [MOVE → infrastructure/logging/] - Infrastructure concern per 08_EVENT_LOGGER.md
```

#### Components (`core/components/`)

```
core/components/
├── __init__.py                                    [CREATE] - Required for new top-level components directory
├── position_monitor.py                            [MOVE FROM core/strategies/components/] - Per 01_POSITION_MONITOR.md
├── exposure_monitor.py                            [MOVE FROM core/strategies/components/] - Per 02_EXPOSURE_MONITOR.md
├── risk_monitor.py                                [MOVE FROM core/strategies/components/] - Per 03_RISK_MONITOR.md
└── position_update_handler.py                     [MOVE FROM core/strategies/components/] - Per 11_POSITION_UPDATE_HANDLER.md
```

#### Execution (`core/execution/`)

```
core/execution/
├── __init__.py                                    [KEEP] - Required for package
└── execution_manager.py                           [KEEP] - Per 04_EXECUTION_MANAGER.md
```

### Infrastructure (`infrastructure/`)

#### Data (`infrastructure/data/`)

```
infrastructure/data/
├── __init__.py                                    [KEEP] - Required for package
└── data_provider_factory.py                       [KEEP] - Per 05_DATA_PROVIDER_FACTORY.md
```

#### Logging (`infrastructure/logging/`)

```
infrastructure/logging/
├── __init__.py                                    [CREATE] - Required for new logging directory
└── event_logger.py                                [MOVE FROM core/strategies/components/] - Per 08_EVENT_LOGGER.md
```

#### API (`infrastructure/api/`)

```
infrastructure/api/
├── __init__.py                                    [KEEP] - Required for package
└── api_call_queue.py                              [KEEP] - Per 09_API_CALL_QUEUE.md
```

### Venue Adapters (`venue_adapters/`)

```
venue_adapters/
├── __init__.py                                    [KEEP] - Required for package
├── aave_adapter.py                                [KEEP] - Per 06_AAVE_ADAPTER.md
└── morpho_adapter.py                              [KEEP] - Per 07_MORPHO_ADAPTER.md
```

## Migration Paths

### Position Monitor
- **From**: `core/strategies/components/position_monitor.py`
- **To**: `core/components/position_monitor.py`
- **Reason**: Core component per 01_POSITION_MONITOR.md, not strategy-specific
- **Update imports in**: strategy files, execution manager, reconciliation component

### Exposure Monitor
- **From**: `core/strategies/components/exposure_monitor.py`
- **To**: `core/components/exposure_monitor.py`
- **Reason**: Core component per 02_EXPOSURE_MONITOR.md, not strategy-specific
- **Update imports in**: strategy files, risk monitor, position monitor

### Risk Monitor
- **From**: `core/strategies/components/risk_monitor.py`
- **To**: `core/components/risk_monitor.py`
- **Reason**: Core component per 03_RISK_MONITOR.md, not strategy-specific
- **Update imports in**: strategy files, execution manager, exposure monitor

### Position Update Handler
- **From**: `core/strategies/components/position_update_handler.py`
- **To**: `core/components/position_update_handler.py`
- **Reason**: Core component per 11_POSITION_UPDATE_HANDLER.md, not strategy-specific
- **Update imports in**: strategy files, execution manager, position monitor

### Event Logger
- **From**: `core/strategies/components/event_logger.py`
- **To**: `infrastructure/logging/event_logger.py`
- **Reason**: Infrastructure concern per 08_EVENT_LOGGER.md, not strategy-specific
- **Update imports in**: all components that use event logging

## Missing Components

### Create: `core/components/__init__.py`
- **Reason**: Required for new top-level components directory
- **Should export**: PositionMonitor, ExposureMonitor, RiskMonitor, PositionUpdateHandler

### Create: `infrastructure/logging/__init__.py`
- **Reason**: Required for new logging directory
- **Should export**: EventLogger

## Files to Delete

### Delete: `core/strategies/components/strategy_manager.py`
- **Reason**: Duplicate of base_strategy_manager.py
- **Safe to delete**: Yes (no unique functionality)

### Delete: `core/strategies/components/data_provider.py`
- **Reason**: Use infrastructure/data/data_provider_factory.py instead
- **Safe to delete**: Yes (superseded by factory pattern)

### Delete: `core/strategies/components/data_subscriptions.py`
- **Reason**: Obsolete, modes use data_requirements config
- **Safe to delete**: Yes (replaced by config-driven approach)

## Validation Results

### Structure Alignment Summary

- **Correct Files**: 34
- **Misplaced Files**: 0
- **Missing Files**: 7
- **Obsolete Files**: 0

### Detailed Results

#### Correct Files (34)
- `core/components/position_monitor.py` - 01_POSITION_MONITOR.md
- `core/components/exposure_monitor.py` - 02_EXPOSURE_MONITOR.md
- `core/components/risk_monitor.py` - 03_RISK_MONITOR.md
- `core/components/position_update_handler.py` - 11_POSITION_UPDATE_HANDLER.md
- `core/components/__init__.py` - Required for package
- `core/strategies/base_strategy_manager.py` - 5B_BASE_STRATEGY_MANAGER.md
- `core/strategies/strategy_factory.py` - 5A_STRATEGY_FACTORY.md
- `core/strategies/pure_lending_strategy.py` - MODES.md
- `core/strategies/btc_basis_strategy.py` - MODES.md
- `core/strategies/eth_basis_strategy.py` - MODES.md
- `core/strategies/eth_staking_only_strategy.py` - MODES.md
- `core/strategies/eth_leveraged_strategy.py` - MODES.md
- `core/strategies/usdt_market_neutral_no_leverage_strategy.py` - MODES.md
- `core/strategies/usdt_market_neutral_strategy.py` - MODES.md
- `core/execution/execution_manager.py` - 04_EXECUTION_MANAGER.md
- `core/execution/__init__.py` - Required for package
- `infrastructure/data/data_provider_factory.py` - 05_DATA_PROVIDER_FACTORY.md
- `infrastructure/data/__init__.py` - Required for package
- `infrastructure/logging/event_logger.py` - 08_EVENT_LOGGER.md
- `infrastructure/logging/__init__.py` - Required for package
- `infrastructure/api/api_call_queue.py` - 09_API_CALL_QUEUE.md
- `venue_adapters/aave_adapter.py` - 06_AAVE_ADAPTER.md
- `venue_adapters/morpho_adapter.py` - 07_MORPHO_ADAPTER.md
- `venue_adapters/__init__.py` - Required for package
- `core/__init__.py` - Required for package
- `infrastructure/__init__.py` - Required for package
- `infrastructure/storage/__init__.py` - Required for package
- `infrastructure/visualization/__init__.py` - Required for package
- `core/interfaces/__init__.py` - Required for package
- `core/math/__init__.py` - Required for package
- `core/health/__init__.py` - Required for package
- `core/error_codes/__init__.py` - Required for package
- `core/instructions/__init__.py` - Required for package
- `core/reconciliation/__init__.py` - Required for package

#### Misplaced Files (0)

#### Missing Files (7)
- `core/strategies/__init__.py` - Required for package
- `infrastructure/api/__init__.py` - Required for package
- `data_provider/__init__.py` - Required for package
- `core/event_engine/__init__.py` - Required for package
- `core/utilities/__init__.py` - Required for package
- `core/rebalancing/__init__.py` - Required for package
- `core/services/__init__.py` - Required for package

#### Obsolete Files (0)

## Success Criteria

### Quality Gate Integration

- [x] Repository structure validation script created and functional
- [x] Script integrated into `run_quality_gates.py` under `repo_structure` category
- [x] Script generates updated TARGET_REPOSITORY_STRUCTURE.md automatically
- [x] All validation checks pass (structure alignment, file mapping)

### Documentation Updates

- [x] REFACTOR_STANDARD_PROCESS.md updated with Agent 5.6
- [x] Success criteria updated with structure validation requirements
- [x] Validation commands added for repository structure
- [x] Success metrics updated

### Agent Configuration

- [x] Agent JSON configuration created
- [x] Agent instructions created
- [x] Agent properly integrated into 9-step process (Phase 3, after Agent 5.5)

### Repository Structure Documentation

- [x] TARGET_REPOSITORY_STRUCTURE.md generated with all annotations
- [x] Migration paths documented for all [MOVE] files
- [x] Justifications provided for all [DELETE] files
- [x] Specifications linked for all [CREATE] files
- [x] 100% of backend files annotated with status

## Next Steps

1. **Review Annotations**: Carefully review all [MOVE], [DELETE], and [CREATE] annotations
2. **Execute Migrations**: Follow migration paths for [MOVE] files
3. **Update Imports**: Update all import statements after file relocations
4. **Delete Obsolete Files**: Remove files marked as [DELETE] after verification
5. **Create Missing Files**: Create files marked as [CREATE] with proper content
6. **Run Tests**: Execute test suite after structure changes
7. **Update Documentation**: Update any documentation that references old file paths

## Canonical Sources

This structure is based on the following canonical documentation:

- `docs/specs/` - Component specifications
- `docs/CODE_STRUCTURE_PATTERNS.md` - Code organization patterns
- `docs/REFERENCE_ARCHITECTURE_CANONICAL.md` - Architecture requirements
- `docs/VENUE_ARCHITECTURE.md` - Venue-specific patterns
- `docs/API_DOCUMENTATION.md` - API structure requirements
